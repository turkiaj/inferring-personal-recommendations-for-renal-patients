---
output: html_document
date: "2023-03-24"
---

## Cross validation

```{r setup, include=FALSE}
library(knitr)
library(kableExtra) # for HTML and Latex tables

knitr::opts_chunk$set(echo = TRUE, fig.align="center", fig.pos = 'H')

# this allows using tikz rendering for plots with "dev=tikz"
knit_hooks$set(plot = function(x, options) {
  if ('tikz' %in% options$dev && !options$external) {
    hook_plot_tex(x, options)
  } else hook_plot_md(x, options)
})

# Fix seed for random number generator for getting consistent results in kmeans etc.
fixed_seed <- 678

# Load common MEBN package
source("mebn/v2/MEBNv2.r")

```

# Dialysis patient data

```{r data_loading, echo=FALSE, message=FALSE, warning=FALSE}
library(lubridate)
library(dplyr)
library(tidyr)

# Read the data description
datadesc_fat_epros <- read.csv(file="data/DIALYSIS_data_description_fat_epros.csv", header = TRUE, sep = ";")

# Read the actual data matching the description
dialysis <- read.csv(file="data/DIALYSIS.csv", sep=";", dec=",")

# Define factors
dialysis$potilas <- factor(dialysis$potilas)
dialysis$nesterajoitus <- factor(dialysis$nesterajoitus)
dialysis$verenpainelaakitys <- factor(dialysis$verenpainelaakitys)
dialysis$verenrasvojen_laakitys <- factor(dialysis$verenrasvojenlaakitys)
dialysis$mielialalaakitys <- factor(dialysis$mielialalaakitys)
dialysis$fosforinsitoja <- factor(dialysis$fosforinsitoja)
dialysis$kaliuminsitoja <- factor(dialysis$kaliuminsitoja)
dialysis$anemian_hoito <- factor(dialysis$anemianhoito)
dialysis$diabeteslaakitys <- factor(dialysis$diabeteslaakitys)
dialysis$antibiootti <- factor(dialysis$antibiootti)
dialysis$marevan <- factor(dialysis$marevan)
dialysis$nesteenpoisto <- factor(dialysis$nesteenpoisto)
dialysis$ummetuslaake <- factor(dialysis$ummetuslaake)
dialysis$verenohennus <- factor(dialysis$verenohennus)
dialysis$akt_dvit <- factor(dialysis$aktdvit)
dialysis$renavit <- factor(dialysis$renavit)
dialysis$cad <- factor(dialysis$cad)

# Calculate missing E% for fats 
# https://fineli.fi/fineli/fi/ravintotekijat/2331

dialysis$mufaepros <- dialysis$mufa * 9 / dialysis$energiakcal * 100 # Rasvan energiakerroin on 37 kJ/g (9 kcal/g)
dialysis$pufaepros <- dialysis$pufa * 9 / dialysis$energiakcal * 100 # Rasvan energiakerroin on 37 kJ/g (9 kcal/g)
#dialysis$safaepros2 <- dialysis$safa * 9 / dialysis$energiakcal * 100 # Rasvan energiakerroin on 37 kJ/g (9 kcal/g)

# Add these new E% features as predictors
mufa_e <- datadesc_fat_epros[datadesc_fat_epros$Name=="mufa",]
mufa_e$Name <- "mufaepros"
mufa_e$Unit <- "E%"
mufa_e$Description <- "Monounsaturated Fatty Acids, E%"
mufa_e$Descriptionfin <- "Mufa E%"
datadesc_fat_epros <- rbind(datadesc_fat_epros, mufa_e)

pufa_e <- datadesc_fat_epros[datadesc_fat_epros$Name=="pufa",]
pufa_e$Name <- "pufaepros"
pufa_e$Unit <- "E%"
pufa_e$Description <- "Polyunsaturated Fatty Acids, E%"
pufa_e$Descriptionfin <- "Pufa E%"
datadesc_fat_epros <- rbind(datadesc_fat_epros, pufa_e)

# Remove g/d features from predictors
datadesc_fat_epros[datadesc_fat_epros$Name=="mufa",]$Order <- 0
datadesc_fat_epros[datadesc_fat_epros$Name=="pufa",]$Order <- 0

# gender: female = 1, male = 0
dialysis$sukupuoli <- factor(ifelse(dialysis$sukupuoli == "nainen", 1, 0))

# Days between laboratory test and food record interview
dialysis$responsedays <- difftime(as.Date(dialysis$labraaika, '%d.%m.%Y'), as.Date(dialysis$ravhaastaika, '%d.%m.%Y'), units = c("days"))

responsedays_desc <- datadesc_fat_epros[datadesc_fat_epros$Name=="ika",]
responsedays_desc$Order <- 0 # OMITTED !!
responsedays_desc$Distribution <- "Integer"  # Filter this out from normalization etc.
responsedays_desc$Name <- "responsedays"
responsedays_desc$Unit <- "days"
responsedays_desc$Description <- "responsetime"
responsedays_desc$Descriptionfin <- "vasteaika"
datadesc_fat_epros <- rbind(datadesc_fat_epros, responsedays_desc)

# important: dataset is ordered by successive patients and observations so that estimation works correctly
dialysis <- dialysis[order(dialysis$potilas, dialysis$havainto),]

# remove patients with one observation only

# dialysis
patients_with_two_obs <- dialysis %>% 
  group_by(potilas) %>% 
  summarise(havainto_sum = sum(havainto)) %>%
  filter(havainto_sum == 3) %>%
  select(potilas) %>%
  unlist() %>% as.vector()

dialysis <- dialysis[dialysis$potilas %in% patients_with_two_obs,]

# - reset patient levels
dialysis$potilas <- factor(dialysis$potilas)

# Define how to iterate through the graph
# - same targets
assumedtargets <- datadesc_fat_epros[datadesc_fat_epros$Order==200,]
```

```{r two_sets_of_predictors, echo=FALSE, message=FALSE}
# - different sets of predictors

## FAT EPROS
assumedpredictors_fat_epros <- datadesc_fat_epros[datadesc_fat_epros$Order==100,]

# Ordering for table
assumedpredictors_fat_epros <- assumedpredictors_fat_epros[order(assumedpredictors_fat_epros$Unit, assumedpredictors_fat_epros$Description),]

gaussian_preds <- as.vector(assumedpredictors_fat_epros[assumedpredictors_fat_epros$Distribution == "Gaussian" | assumedpredictors_fat_epros$Distribution == "LogNormal",]$Name)
show_decimals <- as.vector(assumedpredictors_fat_epros[assumedpredictors_fat_epros$Distribution == "Gaussian" | assumedpredictors_fat_epros$Distribution == "LogNormal",]$Decimals)

pred_table <- as.data.frame(assumedpredictors_fat_epros[assumedpredictors_fat_epros$Distribution == "Gaussian" | assumedpredictors_fat_epros$Distribution == "LogNormal",]$Description, row.names = NULL)

range_mat <- paste0(round(apply(t(dialysis[gaussian_preds]), 1, function(x) mean(x)),show_decimals), " (",round(apply(t(dialysis[gaussian_preds]), 1, function(x) min(x)),show_decimals)," - ",round(apply(t(dialysis[gaussian_preds]), 1, function(x) max(x)),show_decimals),") ", as.vector(assumedpredictors_fat_epros[assumedpredictors_fat_epros$Distribution == "Gaussian",]$Unit))

prior_range <- paste0(assumedpredictors_fat_epros[assumedpredictors_fat_epros$Distribution == "Gaussian",]$Lowerbound, " - ", assumedpredictors_fat_epros[assumedpredictors_fat_epros$Distribution == "Gaussian",]$Upperbound, " ", assumedpredictors_fat_epros[assumedpredictors_fat_epros$Distribution == "Gaussian",]$Unit)

pred_table_fat_epros <- cbind(pred_table, range_mat)
colnames(pred_table_fat_epros) <- c("Nutrient", "Sample avg. (min-max)")
```

```{r model_separate_univariate_preparation, echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
library(rstan)
source("mebn/v2/MEBNv2.r")

rstan_options (auto_write=TRUE)
options (mc.cores=parallel::detectCores ()) 
```


```{r graph_with_gamma_qr_mvcross_two_levels, echo=TRUE, eval=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
pk_fppi_palb_targets <- datadesc_fat_epros[datadesc_fat_epros$Name %in% c('pk','fppi','palb'),]

initial_graph <- mebn.fully_connected_bipartite_graph(datadesc_fat_epros)

dialysis_imputed <- readRDS("data/DIALYSIS_imputed_palb.rds")

# add the dialysis treatment type as a grouping factor
dialysis_imputed$hoitoryhma <- as.factor(dialysis_imputed$hoitomuoto)

# and sort the data by treatment/patient/observation
dialysis_imputed <- dialysis_imputed[order(dialysis_imputed$hoitoryhma, 
                                           dialysis_imputed$potilas, dialysis_imputed$havainto),]

# 10-fold
number_of_folds <- 10
patients <- as.numeric(levels(dialysis_imputed$potilas))
patient_folds <- split(patients, cut(seq_along(patients),number_of_folds,labels = FALSE))

# number of fold
f <- 1

fold <- patient_folds[[f]]

# Data to holdout belonging to patients in the fold
holdout_index <- as.vector(as.numeric(dialysis_imputed$potilas %in% fold))

# Change this path to match your environment
cvmodelpath <- "models/BLMM_gamma_mv_cross"
fold_title <- paste0(f,"_",paste0(fold, collapse = "_"))
cvdir <- paste0(cvmodelpath, "/cvmodels/", fold_title)

if (!dir.exists(cvdir))
{
  dir.create(cvdir)
  
  dialdiet_gamma_mv3_two_level <- mebn.bipartite_two_level_multivariate(
                                     reaction_graph = initial_graph, 
                                     inputdata = dialysis_imputed,
                                     targetdata = holdout_index,
                                     predictor_columns = assumedpredictors_fat_epros, 
                                     assumed_targets = pk_fppi_palb_targets, 
                                     group_column = "hoitoryhma",
                                     subject_column = "potilas",
                                     local_estimation = mebn.two_level_multivariate_sampling,
                                     local_model_cache = cvdir,
                                     stan_model_file = 
                                       "mebn/v2/BLMM_gamma_two_level_grouping.stan",
                                     normalize_values = TRUE)
}

```


```{r extract_personal_generative_models_cv, eval=FALSE, echo=FALSE}
source("mebn/v2/MEBNv2.r")

# Extract generative models for patients with data from personal grouping

# - use these predictors and targets
datadesc <- datadesc_fat_epros
target_variables <- datadesc_fat_epros[datadesc_fat_epros$Name %in% c('pk','fppi','palb'),]
assumedpredictors <- assumedpredictors_fat_epros

# 10-fold
number_of_folds <- 10
patients <- as.numeric(levels(dialysis_imputed$potilas))
patient_folds <- split(patients, cut(seq_along(patients),number_of_folds,labels = FALSE))

# number of fold
f <- 1

fold <- patient_folds[[f]]

# Change this path to match your environment
fold_title <- paste0(f,"_",paste0(fold, collapse = "_"))

# - latent parameters from this model
latent_parameter_modeldir <- paste0("models/BLMM_gamma_mv_cross/cvmodels/", fold_title)

latent_parameter_modeldir <- paste0("models/BLMM_gamma_mv_cross/cvmodels/1_382_480_885_1184")
#latent_parameter_modeldir <- paste0("models/BLMM_gamma_mv_cross/cvmodels/1")

# - output personal generative models (graphml + rv samples) in this dir
graph_dir <- "graphs/mv3_cross_two_levels_cv/"
graph_dir <- "graphs/mv3_cross_two_levels_cv_insample/"

# Loop through patients and produce the models

dialysis <- readRDS("data/DIALYSIS_imputed_palb.rds")

# add the dialysis treatment type as a grouping factor
dialysis$hoitoryhma <- as.factor(dialysis$hoitomuoto)

#for (person_id in 1:length(patients)) {

for (person_id in which(patients %in% fold)) {
  
  # - initial graph structure
  initial_graph <- mebn.fully_connected_bipartite_graph(datadesc)
  
  # - pick the estimated latent variables for all the persons
  local_distributions <- target_variables
  local_distributions$modelcache <- latent_parameter_modeldir
  
  # - get personal data, normalized and original
  
  # - statistics for the nutrition levels are calculated from normalized data (as it was in the likelihood estimation)
  predictors <- nrow(assumedpredictors)
  normalized_input <- sapply(1:predictors, mebn.scale_gaussians, data = dialysis, datadesc = assumedpredictors, log_transform_ln = FALSE)
  normalized_input_df <- as.data.frame(normalized_input)
  
  # - pick rows for the selected person
  subject_code <- levels(dialysis$potilas)[person_id]
  personal_data_df <- cbind(dialysis$potilas, normalized_input_df)
  personal_data_df <- personal_data_df[personal_data_df$`dialysis$potilas` == subject_code,]
  personal_data <- as.matrix(subset(personal_data_df, select = -c(`dialysis$potilas`)))
  
  # - store also these original stats in graph
  personal_data_org <- subset(dialysis[dialysis$potilas == subject_code,], select = as.vector(assumedpredictors$Name))
  personal_concentrations_org <- subset(dialysis[dialysis$potilas == subject_code,], select = as.vector(assumedtargets$Name))
  
  personal_model_dir <- paste0(graph_dir, person_id)
  
  # Generate a personal graph in directory
  
  group_id <- as.numeric(unique(dialysis[dialysis$potilas == subject_code,]$hoitoryhma))

  # two-level model
  personal_graph <- mebn.extract_multilevel_graph(person_id, group_id, initial_graph, personal_model_dir, assumedpredictors, assumedtargets, latent_parameter_modeldir, personal_data, personal_data_org, personal_concentrations_org, datadesc)
  
}

```


```{r simulated_MSE_for_cv, eval=FALSE, echo=FALSE}
library(igraph)
source("mebn/v2/MEBNv2.r")

potassium_org_mean <- mean(dialysis$kalium) # 2755
potassium_org_sd <- sd(dialysis$kalium) # 949
  
phosphorous_org_mean <- mean(dialysis$fosfori) # 2755
phosphorous_org_sd <- sd(dialysis$fosfori) # 949

pk_mean <- mean(dialysis$pk)
fppi_mean <- mean(dialysis$fppi)
palb_mean <- mean(dialysis$palb, na.rm = TRUE)

mse_summary <- data.frame(matrix(ncol = 5, nrow = 0), row.names = NULL)

graph_dir_candidates <- c("mv3_cross_two_levels", "mv3_cross_two_levels_cv")

for (model_dir in graph_dir_candidates) {

  graph_dir <- paste0("graphs/",model_dir,"/")

  for (person_id in 1:5) {
  
    print(paste0("Simulating patient ", person_id))
  
    subject_code <- levels(dialysis$potilas)[person_id]
    treatment <- unique(dialysis[dialysis$potilas == subject_code,]$hoitomuoto)
    
    # Normal ranges of concentration are personalized
    personal_info <- head(dialysis[dialysis$potilas == subject_code,],1)
    recommeded_concentrations <- mebn.get_personal_target_guidelines(personal_info, patient_in_dialysis = TRUE)
    
    personal_model_dir <- paste0(graph_dir,person_id)
    personal_graph <- read.graph(paste0(personal_model_dir, "/personal_graph.graphml"), "graphml")
    
    # Sample diet proposals and matching concentration predictions
    
    repeat_model <- mebn.Query(reaction_graph = personal_graph,
                           graph_dir = personal_model_dir,
                           queried_nodes = c("kalium","fosfori"),
                           query = recommeded_concentrations,
                           proposal_limits = c(((0 - potassium_org_mean) / potassium_org_sd),
                                             ((5800 - potassium_org_mean) / potassium_org_sd),
                                             ((0 - phosphorous_org_mean) / phosphorous_org_sd),
                                             ((2550 - phosphorous_org_mean) / phosphorous_org_sd)),                         
                           stan_model_file = "diet/multivariate_intake_recommendation.stan",
                           conc_lower_limits = as.vector(recommeded_concentrations$lower_limits),
                           conc_upper_limits = as.vector(recommeded_concentrations$upper_limits),
                           beta_point_est = "mean",
                           param_point_est = "mean",
                           X_point_est = "mean",
                           posterior_samples = 1,
                           X_sd_coef = 1,
                           repeat_only = 1)
  
    repeats <- rstan::extract(repeat_model)
   
    pk <- repeats$concentration[,,1]
    fppi <- repeats$concentration[,,2]
    palb <- repeats$concentration[,,3]
     
    true_concs <- dialysis %>%
         filter(potilas == subject_code) %>%
         select(havainto, pk, fppi, palb)
    
    personal_mse <- cbind(subject_code,
                              model_dir,
                              mebn.NRMSE(mean(pk), mean(true_concs$pk), pk_mean),
                              mebn.NRMSE(mean(fppi), mean(true_concs$fppi), fppi_mean),
                              mebn.NRMSE(mean(palb), mean(true_concs$palb), palb_mean))

    mse_summary <- rbind(mse_summary, personal_mse)
  }
}

colnames(mse_summary) <- c("subject", "reaction_model", "pk_nrmse", "fppi_nrmse", "palb_nrmse")

saveRDS(mse_summary, "model_evaluation/NRMSE_comparison_mv_cv_models_5.rds")

write.csv2(mse_summary, file="model_evaluation/NRMSE_comparison_mv_cv_models_5.csv", row.names = FALSE)
mse_summary
```

```{r}
library(dplyr)
library(ggplot2)
library(igraph)

mse_summary <- readRDS("model_evaluation/NRMSE_comparison_mv_cv_models.rds")

mv_model <- mse_summary[mse_summary$reaction_model == "mv3_cross_two_levels",]
cv_pred <- mse_summary[mse_summary$reaction_model == "mv3_cross_two_levels_cv",]

#mean(c(mean(as.numeric(mv_model$pk_nrmse)), mean(as.numeric(mv_model$fppi_nrmse)), mean(as.numeric(mv_model$palb_nrmse)))) #0.002787206
#mean(c(mean(as.numeric(cv_pred$pk_nrmse)), mean(as.numeric(cv_pred$fppi_nrmse)), mean(as.numeric(cv_pred$palb_nrmse)))) #0.2140092

error_analysis.df <- mv_model %>%
  inner_join(cv_pred, by = "subject") %>%
  mutate(pk_error = abs(as.numeric(pk_nrmse.x) - as.numeric(pk_nrmse.y))) %>%
  mutate(fppi_error = abs(as.numeric(fppi_nrmse.x) - as.numeric(fppi_nrmse.y))) %>%
  mutate(palb_error = abs(as.numeric(palb_nrmse.x) - as.numeric(palb_nrmse.y))) %>%
  select(subject, pk_error, fppi_error, palb_error)

error_analysis.df$avg_error <- rowMeans(cbind(error_analysis.df$pk_error, error_analysis.df$fppi_error, error_analysis.df$palb_error))

reaction_rms <- data.frame(matrix(ncol = 5, nrow = 0), row.names = NULL)

# Ennustevirhe ei selity alla olevalla tavalla
# Hypoteesi: virhe kasvaa jos holdout-potilas reagoi eri tavalla kuin malli ennustaa

for (subject_code in error_analysis.df$subject) {
  
  person_id <- which(levels(dialysis_imputed$potilas) == subject_code)
  personal_graph <- read.graph(paste0("graphs/mv3_cross_two_levels/", person_id, "/personal_graph.graphml"), "graphml")
  
  general_effects <- V(personal_graph)[V(personal_graph)$type == "general_effect"]
  pk_general_effects <- general_effects[endsWith(general_effects$name, "_pk")]
  fppi_general_effects <- general_effects[endsWith(general_effects$name, "_fppi")]
  palb_general_effects <- general_effects[endsWith(general_effects$name, "_palb")]
  
  personal_effects <- V(personal_graph)[V(personal_graph)$type == "personal"]
  pk_personal_effects <- personal_effects[endsWith(personal_effects$name, "_pk")]
  fppi_personal_effects <- personal_effects[endsWith(personal_effects$name, "_fppi")]
  palb_personal_effects <- personal_effects[endsWith(personal_effects$name, "_palb")]

  pk_rms <- mean(abs(pk_general_effects$value - pk_personal_effects$value))
  fppi_rms <- mean(abs(fppi_general_effects$value - fppi_personal_effects$value))
  palb_rms <- mean(abs(palb_general_effects$value - palb_personal_effects$value))
  
  rms_between_general_and_personal <- mean(abs(general_effects$value - personal_effects$value))
  
  reaction_rms <- rbind(reaction_rms, c(subject_code, pk_rms, fppi_rms, palb_rms, rms_between_general_and_personal))
}

colnames(reaction_rms) <- c("subject", "pk_reaction_distance", "fppi_reaction_distance", "palb_reaction_distance", "reaction_distance")
reaction_rms$pk_reaction_distance <- as.numeric(reaction_rms$pk_reaction_distance)
reaction_rms$fppi_reaction_distance <- as.numeric(reaction_rms$fppi_reaction_distance)
reaction_rms$palb_reaction_distance <- as.numeric(reaction_rms$palb_reaction_distance)

plot.df <- error_analysis.df %>%
  inner_join(reaction_rms, by="subject")

ggplot(plot.df) +
  geom_point(aes(x = pk_error, y = pk_reaction_distance), color = "black") +
  geom_point(aes(x = fppi_error, y = fppi_reaction_distance), color = "red") +
  geom_point(aes(x = palb_error, y = palb_reaction_distance), color = "blue") 

mse_summary

```
```{r prediction}
library(rstan)

stan_model_file <- "mebn/v2/BLMM_gamma_two_level_prediction.stan"

# reponses
pk_fppi_palb_targets <- datadesc_fat_epros[datadesc_fat_epros$Name %in% c('pk','fppi','palb'),]
assumedtargets <- pk_fppi_palb_targets

# data
dialysis_imputed <- readRDS("data/DIALYSIS_imputed_palb.rds")

# add the dialysis treatment type as a grouping factor
dialysis_imputed$hoitoryhma <- as.factor(dialysis_imputed$hoitomuoto)

# and sort the data by treatment/patient/observation
dialysis_imputed <- dialysis_imputed[order(dialysis_imputed$hoitoryhma, 
                                           dialysis_imputed$potilas, dialysis_imputed$havainto),]

# pick predicted fold
number_of_folds <- 10
patients <- as.numeric(levels(dialysis_imputed$potilas))
patient_folds <- split(patients, cut(seq_along(patients),number_of_folds,labels = FALSE))

# number of fold
f <- 1
fold <- patient_folds[[f]]

inputdata <- dialysis_imputed[dialysis_imputed$potilas %in% fold,]
predictor_columns <- assumedpredictors_fat_epros
target_columns <- pk_fppi_palb_targets
group_column <- "hoitoryhma"
subject_column <- "potilas"
targetdata <- NULL
normalize_values <- TRUE
reg_params <- NULL

# prepare input data
stanDat <- mebn.set_mv_two_level_model_parameters(predictor_columns, target_columns, group_column, subject_column, inputdata, targetdata, normalize_values, reg_params)
stanDat$n_s <- length(fold)

# get prediction info
localfit <- readRDS("models/BLMM_gamma_mv_cross/two_levels/pk_fppi_palb_blmm.rds")
pmodel <- rstan::extract(localfit)

params <- within(list(),
                 {
                   beta_Intercept <- colMeans(pmodel$beta_Intercept)       # vector[v] 
                   beta_stack <- colMeans(pmodel$beta_stack)               # vector[v*(p-1)] 
                   g_stack <- colMeans(pmodel$g_stack)                     # vector[v*k][n_g]
                   g_alpha <- colMeans(pmodel$g_alpha)                     # vector[v] 
                   L_s <- colMeans(pmodel$L_s)                             # cholesky_factor_corr[v*k]
                   stacked_sigma_b_s <- colMeans(pmodel$stacked_sigma_b_s) # vector[v*k]
                 })
  
params <- c(stanDat, params)

rstan_options (auto_write=TRUE)
options (mc.cores=parallel::detectCores ())
  
pred_result <- stan(file=stan_model_file, warmup = 1000, iter=2000, chains=4, chain_id=1L, algorithm="NUTS", control = list(adapt_delta = 0.99, max_treedepth = 15), data=params, seed=483892929)

saveRDS(pred_result, "models/BLMM_gamma_mv_cross/cvmodels/prediction_of_fold_1.rds")


f1 <- rstan::extract(pred_result)

colMeans(f1$personal_effect)[1,,]

#             [,1]       [,2]       [,3]      [,4]      [,5]       [,6]       [,7]       [,8]       [,9]     [,10]       [,11]      [,12]      [,13]       [,14] 
# [1,] -0.55549560 -0.5422927 -0.9252287 0.4076694 0.9773776 0.72806074 -0.5464526  0.4965550  0.2814421 0.5369487  1.07505004  0.4324695 -0.5211899  0.76340476 
# [2,] -0.03412393  0.1567546  0.1324968 0.1514874 0.7368516 0.07286838  0.1950581 -0.0258900 -0.2465498 0.1347548 -0.04155234 -0.1124448 -0.6304638 -0.01316757 
# [3,]  1.10072369  0.6051590  3.2617181 0.3180909 8.2291495 0.33715955  3.7885873  0.5713748 -1.1029995 1.2657535 -1.96792514  1.4271501  1.4254116  1.35777763 
#          [,15]      [,16]     [,17]      [,18]      [,19]      [,20]       [,21]      [,22]
# [1,] 0.2173843   -0.25152162 0.5030715 -0.2948544 -0.2985976 -0.5268897 -0.26715978 -0.3043021
# [2,] 0.5249087   -0.04943655 0.1889010  0.1919664 -0.6712969  0.3644584  0.04849058  0.1361185
# [3,] 1.1028048    2.18432211 0.9055719 -0.2468975 -0.2180041 -2.8385589 -1.00216349  1.5281516

colMeans(pmodel$personal_effect)[1,,]

#            [,1]        [,2]        [,3]       [,4]      [,5]       [,6]       [,7]        [,8]       [,9]     [,10]       [,11]      [,12]      [,13]       [,14]
# [1,] -0.9582405 -0.60911515 -1.07789319  0.3662606 0.9323664 0.78524748 -0.6451500  0.58878691  0.3862581 0.5149180  1.01249981  0.3136776 -0.3604030  0.96402225
# [2,] -0.3259153  0.04019945 -0.05229621  0.1769445 0.8293997 0.06116893  0.1282111 -0.02971083 -0.2290407 0.1190545 -0.06110787 -0.1506061 -0.6529854 -0.07012724
# [3,]  1.4274491  0.50641644  3.32144497 -0.5557726 8.6202607 0.54342137  3.9087613  0.86828878 -1.1140088 1.2379696 -1.83613492  1.9197873  0.9610049  1.45208416
#          [,15]      [,16]     [,17]      [,18]      [,19]      [,20]       [,21]      [,22]
# [1,] 0.2985909 -0.3610950 0.5107339 -0.1634608 -0.2037745 -0.5681660 -0.28494567 -0.3448214
# [2,] 0.4637436 -0.1704136 0.1999823  0.1868170 -0.7284429  0.4021748  0.06354545  0.1928145
# [3,] 1.3929735  2.3095673 1.1980458 -0.6814966 -0.6213979 -3.2058555 -1.28874149  1.5980622


params$Y

#           33    71     8    49    38    76       34    72
# pk    4.40000  5.60  3.70  3.50  5.90  3.50  3.10000  3.80
# fppi  1.27000  1.52  1.73  1.44  1.72  1.27  1.85000  2.08
# palb 33.46272 38.00 38.00 40.00 20.00 20.00 33.46272 33.00

colMeans(f1$Y_rep)

#            [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]      [,8]
#  [1,]  4.399770  5.599672  3.700505  3.499609  5.900187  3.499984  3.099655  3.799794
#  [2,]  1.270024  1.519932  1.730157  1.440002  1.720174  1.270263  1.849999  2.079726
#  [3,] 33.463184 38.000050 37.998270 39.999982 20.001136 19.999086 33.464936 32.997361

```





